name: Nightly

on:
  push:
  workflow_dispatch:

jobs:
  build-Linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Setup JDK 17
      uses: actions/setup-java@v2
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build with gradle
      run: |
        #!/bin/bash -x
        printenv | sort
        ./gradlew --info build
        
    - name: Create app-image using JPackage
      run: |
        #!/bin/bash -x
        set -x
        echo --Preparing directories
        mkdir -p app/build/jpackage_input || exit 1
        mkdir -p app/build/resources/jpackage || exit 1
        cp app/src/jpackage/resources/* app/build/resources/jpackage
        APPVERSION=`basename app/build/distributions/*.zip .zip`
        VERSION=`echo $APPVERSION | cut -d- -f2-`
        pushd .;cd app/build/jpackage_input;unzip ../distributions/*.zip;popd
        echo --Checking directories...
        find app/build/jpackage_input
        find app/build/distributions
        find app/build/resources
        echo --Running jpackage...
        jpackage --verbose --type app-image --dest app/build/app-image -i "app/build/jpackage_input/app-${VERSION}/lib" --main-jar "app-${VERSION}.jar" --main-class settlers.installer.App --name SettlersRemake --app-version "${VERSION}" --description 'Settlers 3 remake - see https://github.com/' --vendor Hiran, --icon "app/build/resources/main/siedler3-helme-logo.png" --resource-dir "app/build/resources/jpackage"
        echo --Checking output directory
        find app/build/app-image
        
    - Name: Modify app-image
      run: |
        #!/bin/bash -x
        ./gradlew --info filterResourcesCopy
        find app/build/app-image

    - Name: Build package
      run: |
        #!/bin/bash -x
        jpackage --verbose --app-image build/app-image/SettlersRemake --name SettlersRemake --dest build/distributions --resource-dir build/resources/jpackage
        find app/build/app-image

    - uses: actions/upload-artifact@v2
      with:
        name: SettlersRemake
        path: app/build/distributions/*

#  build-Windows:
#    runs-on: windows-latest
#    
#    steps:
#    - uses: actions/checkout@v2
#    - name: Setup JDK 17
#      uses: actions/setup-java@v2
#      with:
#        java-version: '17'
#        distribution: 'temurin'
#    - uses: gradle/gradle-build-action@v2
#      with:
#        arguments: --info jpackage

#  build-MacOS:
#    runs-on: macos-latest
#
#    steps:
#    - uses: actions/checkout@v2
#    - name: Setup JDK 17
#      uses: actions/setup-java@v2
#      with:
#        java-version: '17'
#        distribution: 'temurin'
#
#    - name: Build with gradle
#      run: |
#        printenv | sort
#        ./gradlew --info jpackage
#        ls -l app/build
